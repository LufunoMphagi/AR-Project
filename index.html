<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>We’re Still Marching</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <!-- A-Frame & AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <!-- GIF shader (for transparent GIFs) -->
  <script src="https://unpkg.com/aframe-gif-shader/dist/aframe-gif-shader.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
      position: fixed;
    }

    /* Camera feed fills screen - FIXED */
    video#arjs-video,
    video.arjs-video {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      background: #000 !important;
      z-index: 0 !important;
    }

    /* Canvas overlay - FIXED */
    a-scene {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 1 !important;
    }

    .a-canvas,
    canvas.a-canvas {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      background: transparent !important;
    }

    /* Start overlay */
    #start {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .9);
      color: #fff;
      z-index: 3;
      text-align: center;
      padding: 24px;
    }

    #start button {
      margin-top: 12px;
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 8px;
      border: 0;
      background: #ff6b6b;
      color: #fff;
      cursor: pointer;
    }

    #soundUnlock {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
      background: rgba(0, 0, 0, .7);
      color: #fff;
      border: 1px solid #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
  </style>
</head>

<body>

  <div id="start">
    <h2>We’re Still Marching — AR Prototype</h2>
    <p>Tap Start, allow camera, then point at the printed <b>KANJI</b>, <b>HIRO</b>, <b>CIRCLE</b>, <b>TRIANGLE</b>, or
      <b>T</b> marker.</p>
    <button id="startBtn">Start</button>
  </div>

  <button id="soundUnlock">Tap to enable sound</button>

  <a-scene embedded vr-mode-ui="enabled:false" renderer="alpha:true; antialias:true"
    arjs="sourceType: webcam; debugUIEnabled:false" loading-screen="enabled:false">

    <a-assets timeout="1">
      <!-- INTRO stop assets -->
      <img id="introPosterImg" src="assets/intro-poster.png" crossorigin="anonymous">
      <audio id="introAudio" src="assets/intro_audio.mp3" preload="auto" playsinline webkit-playsinline></audio>

      <!-- THEMBEKA stop assets -->
      <img id="thembekaGif" src="assets/thembeka_small.gif" crossorigin="anonymous">
      <audio id="thembekaAudio" src="assets/thembeka_audio.mp3" preload="auto" playsinline webkit-playsinline></audio>

      <!-- NALEDI stop assets -->
      <img id="nalediGif" src="assets/naledi_final.gif" crossorigin="anonymous">
      <audio id="nalediAudio" src="assets/naledi_audio.mp3" preload="auto" playsinline webkit-playsinline></audio>

      <!-- LERATO stop assets -->
      <img id="leratoGif" src="assets/Lerato.gif" crossorigin="anonymous">
      <audio id="leratoAudio" src="assets/lerato_audio.mp3" preload="auto" playsinline webkit-playsinline></audio>

      <!-- EXIT stop assets -->
      <img id="exitPosterImg" src="assets/exit-poster.png" crossorigin="anonymous">
      <audio id="endingAudio" src="assets/ending_audio.mp3" preload="auto" playsinline webkit-playsinline></audio>
    </a-assets>

    <!-- ===== INTRO (KANJI) ===== -->
    <a-marker id="introMarker" preset="kanji" emitevents="true">
      <a-image id="introPoster" src="#introPosterImg" position="0 3.5 0" rotation="0 0 0" width="12" height="4"
        visible="false"></a-image>
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-marker>

    <!-- ===== THEMBEKA (HIRO) ===== -->
    <a-marker id="thembekaMarker" preset="hiro" emitevents="true">
      <a-plane id="thembekaPoster" position="0 2 0" rotation="0 0 0" width="6.2" height="7.2"
        material="shader: gif; src: #thembekaGif; transparent: true; alphaTest: 0.01" visible="false"></a-plane>
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-marker>

    <!-- ===== NALEDI (CIRCLE pattern) ===== -->
    <a-marker id="nalediMarker" type="pattern" url="assets/pattern-circle.patt" emitevents="true">
      <a-plane id="nalediPoster" position="0 2 0" rotation="0 0 0" width="6.2" height="7.2"
        material="shader: gif; src: #nalediGif; transparent: true; alphaTest: 0.6; depthWrite: false"
        visible="false"></a-plane>

      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-marker>

    <!-- ===== LERATO (TRIANGLE pattern) ===== -->
    <a-marker id="leratoMarker" type="pattern" url="assets/pattern-triangle.patt" emitevents="true">
      <a-plane id="leratoPoster" position="0 2 0" rotation="0 0 0" width="6.2" height="7.2"
        material="shader: gif; src: #leratoGif; transparent: true; alphaTest: 0.01" visible="false"></a-plane>
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 2 1"></a-entity>
    </a-marker>

    <!-- ===== EXIT (T pattern) ===== -->
    <a-marker id="exitMarker" type="pattern" url="assets/pattern-T_marker.patt" emitevents="true">
      <a-image id="exitPoster" src="#exitPosterImg" position="0 4 0" rotation="0 0 0" width="12" height="4"
        visible="false"></a-image>
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="1 3 2"></a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const startUI = document.getElementById('start');
    const startBtn = document.getElementById('startBtn');
    const unlockBtn = document.getElementById('soundUnlock');

    // INTRO
    const introMarker = document.getElementById('introMarker');
    const introPoster = document.getElementById('introPoster');
    const introAudio = document.getElementById('introAudio');

    // THEMBEKA
    const thembekaMarker = document.getElementById('thembekaMarker');
    const thembekaPoster = document.getElementById('thembekaPoster');
    const thembekaAudio = document.getElementById('thembekaAudio');

    // NALEDI
    const nalediMarker = document.getElementById('nalediMarker');
    const nalediPoster = document.getElementById('nalediPoster');
    const nalediAudio = document.getElementById('nalediAudio');

    // LERATO
    const leratoMarker = document.getElementById('leratoMarker');
    const leratoPoster = document.getElementById('leratoPoster');
    const leratoAudio = document.getElementById('leratoAudio');

    // EXIT
    const exitMarker = document.getElementById('exitMarker');
    const exitPoster = document.getElementById('exitPoster');
    const endingAudio = document.getElementById('endingAudio');

    let userPrimed = false;

    /* Sync canvas */
    function syncCanvasToVideo() {
      const v = document.querySelector('video#arjs-video, video.arjs-video');
      const c = document.querySelector('canvas.a-canvas');
      if (!v || !c) return;
      const r = v.getBoundingClientRect();
      c.style.top = r.top + 'px';
      c.style.left = r.left + 'px';
      c.style.width = r.width + 'px';
      c.style.height = r.height + 'px';
    }
    const bootSync = setInterval(syncCanvasToVideo, 100);
    setTimeout(() => clearInterval(bootSync), 4000);
    window.addEventListener('resize', syncCanvasToVideo);
    window.addEventListener('orientationchange', () => setTimeout(syncCanvasToVideo, 300));

    /* Helpers */
    function hideAllPosters() {
      introPoster.setAttribute('visible', 'false');
      thembekaPoster.setAttribute('visible', 'false');
      nalediPoster.setAttribute('visible', 'false');
      leratoPoster.setAttribute('visible', 'false');
      exitPoster.setAttribute('visible', 'false');
    }

    function playOnly(audioEl) {
      [introAudio, thembekaAudio, nalediAudio, leratoAudio, endingAudio].forEach(a => {
        try { a.pause(); a.currentTime = 0; } catch (_) { }
      });
      if (userPrimed) audioEl.play().catch(() => unlockBtn.style.display = 'block');
      else unlockBtn.style.display = 'block';
    }

    /* Start */
    startBtn.addEventListener('click', async () => {
      try {
        await introAudio.play(); introAudio.pause(); introAudio.currentTime = 0;
        await thembekaAudio.play(); thembekaAudio.pause(); thembekaAudio.currentTime = 0;
        await nalediAudio.play(); nalediAudio.pause(); nalediAudio.currentTime = 0;
        await leratoAudio.play(); leratoAudio.pause(); leratoAudio.currentTime = 0;
        await endingAudio.play(); endingAudio.pause(); endingAudio.currentTime = 0;
      } catch (_) { }
      userPrimed = true;
      startUI.style.display = 'none';
      setTimeout(syncCanvasToVideo, 200);
    });

    /* Event listeners for all markers */
    function setupMarker(marker, poster, audio) {
      marker.addEventListener('markerFound', () => {
        hideAllPosters();
        poster.setAttribute('visible', 'true');
        playOnly(audio);
      });
      marker.addEventListener('markerLost', () => {
        poster.setAttribute('visible', 'false');
        try { audio.pause(); audio.currentTime = 0; } catch (_) { }
      });
    }

    setupMarker(introMarker, introPoster, introAudio);
    setupMarker(thembekaMarker, thembekaPoster, thembekaAudio);
    setupMarker(nalediMarker, nalediPoster, nalediAudio);
    setupMarker(leratoMarker, leratoPoster, leratoAudio);
    setupMarker(exitMarker, exitPoster, endingAudio);

    /* iOS unlock */
    unlockBtn.addEventListener('click', () => {
      [introAudio, thembekaAudio, nalediAudio, leratoAudio, endingAudio]
        .find(a => a.paused)
        ?.play()
        .then(() => unlockBtn.style.display = 'none')
        .catch(() => { });
    });
  </script>
</body>

</html>